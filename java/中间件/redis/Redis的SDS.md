# Redis的SDS

​       **Redis面试中经常被问到，Redis效率为什么这么快，很多同学往往回答：① Redis基于内存操作；② Redis是单线程的，采用了IO多路复用技术；③ Redis未使用C语言字符串，使用了SDS字符串。然而，很少有人能说清楚SDS字符串到底是什么，为什么使用SDS字符串比使用C语言字符串效率要高。**



### 什么是SDS

```
SDS全拼为：simple dynamic string，解释为：简单动态字符串
```

##### 1.为什么redis自己要构建SDS字符串？

```
   C语言字符串使用长度为n+1的字符数组来表示长度为n的字符串，并且字符数组的最后一个元素总是空字符'\0'，因为这种字符串表示方式不能满足Redis对字符串在安全性、效率以及功能方面的要求，所以Redis自己构建了SDS，用于满足其需求。
```

##### 2.redis的c语言的字符串和SDS字符串分别作了哪些事？

```
  1.c语言字符串：在Redis里，C语言字符串只用于一些无须对字符串值进行修改的地方，比如：日志。
  2.sds字符串：在Redis中，包含字符串值的键值对都是使用SDS实现的，除此之外，SDS还被用于AOF缓冲区、客户端状态的输入缓冲区。
```

##### 3.SDS定义

```
struct sdshdr{
    //字节数组
    char buf[]; 
    //buf数组中已使用字节数量
    int len;
    //buf数组中未使用字节数量
    int free;
}
```

![微信图片_20190529181941](C:\Users\A\Pictures\Camera Roll\微信图片_20190529181941.jpg)

##### 4.为什么使用SDS？

```
1.相比c语言字符串，使获取字符串长度时间复杂度降为O(1):
   C语言字符串不记录自身长度，如果想获取自身长度必须遍历整个字符串，对每个字符进行计数，这个操作时间复杂度是O(n)。相比较而言，Redis程序只要访问SDS的len属性就可以直接获取到字符串长度，时间复杂度为O(1)，确保获取字符串长度不会成为Redis性能瓶颈，比如对字符串键反复执行strlen命令。如：获取“Redis”字符串长度时程序会直接访问len属性即可，该字符串长度为5。

2.减少修改字符串时带来的内存重分配次数
   C语言字符串底层是使用一个n+1个字符长度的char类型数据实现的，所以每次增长或缩短一个C语言字符串，程序都要对这个字符串数组进行一次内存重分配操作：
   在SDS中通过未使用空间解除了字符串长度和底层数组长度之间的关联，在SDS中，buf数组长度不一定是字符串长度加1，数组中可能包含未使用的字节，这些字节的数量就是由SDS的free属性记录。通过未使用空间，SDS实现了空间预分配和惰性空间释放两种优化策略。

3.空间预分配
  用于字符串增长操作，当字符串增长时，程序会先检查需不需要对SDS空间进行扩展，如果需要扩展，程序不仅会为SDS分配修改所必要的空间，还会为SDS分配额外的未使用空间，额外分配的未使用空间公式如下：
        ① 如果对SDS修改之后，SDS的长度（修改之后len属性的值）小于1MB，那么则分配和len属性同样大小的未使用空间，这时SDS的len属性和free属性的值相同。如：如果修改之后SDS的len将变为10字节，那么程序也会分配10字节的未使用空间，SDS的buf数组实际长度变为10 + 10 + 1 = 21（额外一个字节用于保存结束符\n）
        ② 如果对SDS修改之后，SDS的长度大于等于1MB，那么程序会分配1MB的未使用空间。如：修改之后的len将变为10MB，那么程序会分配1MB的未使用空间，SDS的bug数组长度为10MB + 1MB + 1byte
```

