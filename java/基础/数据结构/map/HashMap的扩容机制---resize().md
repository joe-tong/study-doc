# HashMap的扩容机制---resize()

**HashMap底层逻辑**

```
    当我们往hashmap中put元素的时候，先根据key的hash值得到这个元素在数组中的位置（即下标），然后就可以把这个元素放到对应的位置中了。如果这个元素所在的位子上已经存放有其他元素了，那么在同一个位子上的元素将以链表的形式存放，新加入的放在链头，最先加入的放在链尾。从hashmap中get元素时，首先计算key的hashcode，找到数组中对应位置的某一元素，然后通过key的equals方法在对应位置的链表中找到需要的元素。
```

**带着问题去思考？**

#### 1.获取数组指针算法是什么？

```
（length - 1) & hash

通过key获取hash值，然后‘&’数组长度减一的值

```

#### 2.为什么HashMap数组长度默认为16？

这个问题其实可以分成2个问题：
1.默认长度为什么2的n次幂方
2.为什么选择16作为默认长度

**默认长度为什么2的n次幂方？**

```
    为什么hashmap的数组初始化大小都是2的次方大小时，hashmap的效率最高？我以2的4次方举例，来解释一下为什么数组大小为2的幂时hashmap访问的性能最高。 
```

![4b3732d6-fb5f-369b-b50d-e8b8325c69d4](D:\work_doc\4b3732d6-fb5f-369b-b50d-e8b8325c69d4.jpg)

解释说明：

```
   看上图，左边两组是数组长度为16（2的4次方），右边两组是数组长度为15。两组的hashcode均为8和9，但是很明显，当它们和1110“与”的时候，产生了相同的结果，也就是说它们会定位到数组中的同一个位置上去，这就产生了碰撞，8和9会被放到同一个链表上，那么查询的时候就需要遍历这个链表，得到8或者9，这样就降低了查询的效率。
```

```
   同时，我们也可以发现，当数组长度为15的时候，hashcode的值会与14（1110）进行“与”，那么最后一位永远是0，而0001，0011，0101，1001，1011，0111，1101这几个位置永远都不能存放元素了，空间浪费相当大，更糟的是这种情况中，数组可以使用的位置比数组长度小了很多，这意味着进一步增加了碰撞的几率，减慢了查询的效率！ 
```

结论：

```
   所以说，当数组长度为2的n次幂的时候，不同的key算得得index相同的几率较小，那么数据在数组上分布就比较均匀，也就是说碰撞的几率小，相对的，查询的时候就不用遍历某个位置上的链表，这样查询效率也就较高了。
```

**那为什么选择16作为默认值呢？**

```
在小数据量的情况下16比15和20更能减少key之间的碰撞，而加快查询效率。所以在存储大容量数据的时候，最好预先指定hashmap为2的整数次幂次方，就算不指定的话也会以大于且最接近指定值大小的2次幂来初始化的
```

####   3、hashmap的resize 

```
  当hashmap中的元素越来越多的时候，碰撞的几率也就越来越高（因为数组的长度是固定的），所以为了提高查询的效率，就要对hashmap的数组进行扩容，数组扩容这个操作也会出现在ArrayList中，所以这是一个通用的操作，很多人对它的性能表示过怀疑，不过想想我们的“均摊”原理，就释然了，而在hashmap数组扩容之后，最消耗性能的点就出现了：原数组中的数据必须重新计算其在新数组中的位置，并放进去，这就是resize。
```

```
   那么hashmap什么时候进行扩容呢？当hashmap中的元素个数超过数组大小*loadFactor时，就会进行数组扩容，loadFactor的默认值为0.75，也就是说，默认情况下，数组大小为16，那么当hashmap中元素个数超过16*0.75=12的时候，就把数组的大小扩展为2*16=32，即扩大一倍，然后重新计算每个元素在数组中的位置，而这是一个非常消耗性能的操作，所以如果我们已经预知hashmap中元素的个数，那么预设元素的个数能够有效的提高hashmap的性能。比如说，我们有1000个元素new HashMap(1000), 但是理论上来讲new HashMap(1024)更合适，不过上面annegu已经说过，即使是1000，hashmap也自动会将其设置为1024。 但是new HashMap(1024)还不是更合适的，因为0.75*1000 < 1000, 也就是说为了让0.75 * size > 1000, 我们必须这样new HashMap(2048)才最合适，既考虑了&的问题，也避免了resize的问题。      
```

java -jar -Xdebug -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=8060 bnb-system-1.6.1beta.jar --spring.profiles.active=prod --kxFaceAuto=3 --verifyFaceAuto=3 --kexin.supervision.switch=1 --kunming.supervision.switch=1 --guiyang.supervision.switch=1 --zhuhai.supervision.switch=1 --shenzhen.supervision.switch=1 --xinghuo.upload=0